<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chamador de Bingo Infantil (Vue.js)</title>
    <!-- Carregar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Carregar Vue 3 (em vez de React e Babel) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    
    <!-- Carregar Depend√™ncias do PDF (apenas jsPDF √© necess√°rio agora) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas foi removido -->

    <style>
        /* Estilos globais para uma fonte mais arredondada (fallback) */
        body {
            font-family: 'Nunito', 'Inter', sans-serif; /* Tenta carregar Nunito (arredondada), se n√£o, Inter */
        }
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap');
        [v-cloak] { display: none; }
    </style>
</head>
<body class="bg-blue-100">
    
    <!-- Cont√©m a aplica√ß√£o Vue -->
    <div id="app" v-cloak>

        <!-- Container principal (mobile-first) -->
        <div class="min-h-screen p-4 flex flex-col items-center">
            
            <!-- O componente Modal (Popup) -->
            <print-modal 
                :is-open="isModalOpen" 
                @close="isModalOpen = false" 
                @generate="handleGenerateAndPrint">
            </print-modal>
              
            <div class="w-full max-w-md mx-auto bg-white shadow-2xl rounded-3xl p-6 flex flex-col gap-6">

                <h1 class="text-4xl font-extrabold text-blue-600 text-center">
                  Bingo Infantil
                </h1>

                <!-- --- Sec√ß√£o do Sorteio --- -->
                <div class="flex flex-col items-center gap-4">
                  
                  <!-- O N√∫mero Sorteado -->
                  <div class="w-48 h-48 rounded-full flex flex-col items-center justify-center shadow-inner transition-colors duration-300"
                       :class="{'bg-gray-200': nextNumber === null, 'bg-yellow-400': nextNumber !== null}">
                    
                    <span v-if="letter" class="text-4xl font-bold text-black opacity-70">
                        {{ letter }}
                    </span>
                    
                    <span class="font-extrabold"
                          :class="{
                            'text-4xl text-red-600': nextNumber === 'FIM!', 
                            'text-8xl text-black': nextNumber !== 'FIM!'
                          }">
                      {{ nextNumber === null ? '...' : nextNumber }}
                    </span>
                  </div>
                  
                  <p class="text-lg text-gray-500 font-semibold">
                    N√∫meros em falta: {{ availableNumbers.length }}
                  </p>

                  <!-- Bot√µes Principais -->
                  <button
                    @click="callNextNumber"
                    :disabled="availableNumbers.length === 0"
                    class="w-full py-4 bg-green-500 text-white font-bold text-2xl rounded-full shadow-lg hover:bg-green-600 transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-95"
                  >
                    {{ callButtonText }}
                  </button>
                  <button
                    @click="handleReset"
                    class="w-full py-3 bg-red-500 text-white font-semibold text-xl rounded-full shadow-lg hover:bg-red-600 transition duration-300 transform active:scale-95"
                  >
                    Reiniciar Jogo
                  </button>
                </div>

                <!-- --- √öltimos Sorteados --- -->
                <div v-if="calledNumbers.length > 0" class="border-t-2 border-gray-100 pt-4">
                  <h3 class="text-lg font-bold text-gray-600 mb-3 text-center">
                    √öltimos Sorteados:
                  </h3>
                  <div class="flex flex-wrap gap-2 justify-center">
                    <div 
                      v-for="(number, index) in last5Called"
                      :key="index"
                      class="w-12 h-12 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold text-lg shadow-md"
                    >
                      {{ number }}
                    </div>
                  </div>
                </div>

                <!-- --- Bot√£o de Impress√£o --- -->
                <div class="border-t-2 border-gray-100 pt-4 mt-2">
                  <button
                    @click="isModalOpen = true"
                    :disabled="isPrinting"
                    class="w-full py-3 bg-purple-600 text-white font-bold text-xl rounded-full shadow-lg hover:bg-purple-700 transition duration-300 transform active:scale-95 disabled:opacity-50 disabled:cursor-wait"
                  >
                    {{ isPrinting ? 'A Gerar PDF...' : 'üñ®Ô∏è Imprimir Cart√µes' }}
                  </button>
                </div>

            </div>
              
            <!-- Container de Impress√£o Oculto e componente BingoCardPrint foram removidos -->

        </div>
    </div> <!-- Fim de #app -->

    <!-- Container oculto de impress√£o (agora vazio, mas mantido por precau√ß√£o no DOM) -->
    <div id="print-container" class="absolute -left-[9999px] top-0 w-0 h-0 overflow-hidden"></div>

    <script>
        // --- Constantes Globais e Helpers ---
        const { createApp, ref, computed, nextTick } = Vue;
        
        // As bibliotecas jsPDF est√° dispon√≠vel globalmente
        const jsPDF = window.jspdf ? window.jspdf.jsPDF : null;
        
        // --- Constantes do Bingo (75 Bolas) ---
        const BINGO_LETTERS = ['B', 'I', 'N', 'G', 'O'];
        const BINGO_RANGES = [
          [1, 15],   // B
          [16, 30],  // I
          [31, 45],  // N
          [46, 60],  // G
          [61, 75]   // O
        ];
        const TOTAL_NUMBERS = 75;

        // --- Utilidade para Gerar Cart√µes (Helper) ---
        const generateCard = () => {
          const card = [];
          BINGO_LETTERS.forEach((letter, colIndex) => {
            const [min, max] = BINGO_RANGES[colIndex];
            const available = Array.from({ length: max - min + 1 }, (_, i) => min + i);
            const column = [];
            
            for (let i = 0; i < 5; i++) {
              if (letter === 'N' && i === 2) {
                column.push('LIVRE'); 
              } else {
                const randomIndex = Math.floor(Math.random() * available.length);
                column.push(available[randomIndex]);
                available.splice(randomIndex, 1);
              }
            }
            card.push({ letter, numbers: column });
          });
          return card;
        };
        
        // --- Cria√ß√£o da Aplica√ß√£o Vue ---
        const app = createApp({
          setup() {
            // --- Estado Reativo (Refs) ---
            const bingoCards = ref([]); 
            const calledNumbers = ref([]);
            const nextNumber = ref(null);
            const availableNumbers = ref(
              Array.from({ length: TOTAL_NUMBERS }, (_, i) => i + 1)
            );
            const isPrinting = ref(false); 
            const isModalOpen = ref(false);

            // --- Estado Derivado (Computeds) ---
            const last5Called = computed(() => {
              return calledNumbers.value.slice(-5).reverse();
            });

            const getLetterForNumber = (number) => {
              if (number === null || typeof number !== 'number') return '';
              for (let i = 0; i < BINGO_RANGES.length; i++) {
                const [min, max] = BINGO_RANGES[i];
                if (number >= min && number <= max) {
                  return BINGO_LETTERS[i];
                }
              }
              return '';
            };

            const letter = computed(() => getLetterForNumber(nextNumber.value));

            const callButtonText = computed(() => {
              if (availableNumbers.value.length === TOTAL_NUMBERS) return 'COME√áAR!';
              if (availableNumbers.value.length === 0) return 'FIM!';
              return 'SORTEAR';
            });
            
            // --- Fun√ß√µes (M√©todos) ---
            const callNextNumber = () => {
              if (availableNumbers.value.length === 0) {
                nextNumber.value = 'FIM!';
                return;
              }

              const randomIndex = Math.floor(Math.random() * availableNumbers.value.length);
              const newNumber = availableNumbers.value[randomIndex];

              nextNumber.value = newNumber;
              calledNumbers.value.push(newNumber);
              
              availableNumbers.value.splice(randomIndex, 1);
            };
            
            const handleReset = () => {
              calledNumbers.value = [];
              nextNumber.value = null;
              availableNumbers.value = Array.from({ length: TOTAL_NUMBERS }, (_, i) => i + 1);
              bingoCards.value = []; // Limpa os cart√µes
            };
            
            // --- L√≥gica de Impress√£o (Puro jsPDF) ---
            const handleGenerateAndPrint = async (numCardsToPrint) => {
                if (isNaN(numCardsToPrint) || numCardsToPrint <= 0) {
                    isModalOpen.value = false;
                    return;
                }

                isModalOpen.value = false;
                isPrinting.value = true;

                // 1. Gerar os cart√µes (apenas dados)
                const newCards = Array.from({ length: numCardsToPrint }, () => generateCard());
                bingoCards.value = newCards; 

                // 2. Chamar a impress√£o (s√≠ncrona)
                await printCardsJsPDF();
                
                isPrinting.value = false;
                bingoCards.value = []; // Limpa a mem√≥ria ap√≥s a impress√£o
            };

            const printCardsJsPDF = async () => {
              if (!jsPDF) {
                  console.error("jsPDF n√£o est√° carregado.");
                  isPrinting.value = false;
                  return;
              }

              const doc = new jsPDF({
                orientation: 'portrait',
                unit: 'mm',
                format: 'a4'
              });

              const pageW = 210;
              const pageH = 297;
              const margin = 10;
              
              // --- FIX: Recalculando dimens√µes para garantir 5 colunas quadradas ---
              const cardW = (pageW - 3 * margin) / 2; // Largura do cart√£o: (210 - 30) / 2 = 90 mm
              const headerH = 8; // Altura do cabe√ßalho BINGO
              const cellS = cardW / 5; // Tamanho da c√©lula (Largura e Altura): 90mm / 5 = 18mm (Garante 5 colunas)
              const gridH = cellS * 5; // Altura da grade: 90 mm
              const cardH = headerH + gridH + 2; // Altura total do cart√£o (8mm header + 90mm grid + 2mm padding) ~100mm
              
              // Posi√ß√µes ajustadas com a nova cardH fixa
              const positions = [
                  { x: margin, y: margin }, // Canto Sup Esquerdo
                  { x: margin * 2 + cardW, y: margin }, // Canto Sup Direito
                  { x: margin, y: margin + cardH + margin }, // Canto Inf Esquerdo
                  { x: margin * 2 + cardW, y: margin + cardH + margin }, // Canto Inf Direito
              ];
              
              const cardsToPrint = bingoCards.value;
              let cardsOnPage = 0;

              // Itera pelos dados dos cart√µes
              for (let i = 0; i < cardsToPrint.length; i++) {
                  const cardData = cardsToPrint[i];
                  
                  const posIndex = cardsOnPage % 4; 
                  
                  if (posIndex === 0 && i > 0) {
                      doc.addPage();
                  }
                  
                  const { x: startX, y: startY } = positions[posIndex];
                  
                  // --- 1. Desenhar Borda do Cart√£o ---
                  doc.setLineWidth(0.5);
                  doc.setDrawColor(0, 0, 0); // Preto
                  doc.setLineCap('square');
                  doc.rect(startX, startY, cardW, cardH, 'S'); // 'S' - apenas contorno
                  
                  // --- 2. T√≠tulo (Cart√£o n.¬∫ X) ---
                  doc.setFontSize(12);
                  doc.setFont('Helvetica', 'bold');
                  doc.setTextColor(0, 0, 0); // Preto
                  doc.text(`Cart√£o n.¬∫ ${i + 1}`, startX + cardW / 2, startY + 5, { align: 'center' });

                  // --- 3. Cabe√ßalho BINGO ---
                  let currentY = startY + 7; // Come√ßa um pouco abaixo do t√≠tulo
                  
                  for (let colIndex = 0; colIndex < BINGO_LETTERS.length; colIndex++) {
                      const letter = BINGO_LETTERS[colIndex];
                      const currentX = startX + colIndex * cellS;
                      
                      // Desenha o fundo e borda da c√©lula do cabe√ßalho
                      doc.setDrawColor(0, 0, 0);
                      doc.setFillColor(50, 50, 50); // Cinza Escuro
                      doc.rect(currentX, currentY, cellS, headerH, 'FD'); // Fill and Draw
                      
                      // Escreve a letra (B, I, N, G, O)
                      doc.setTextColor(255, 255, 255); // Cor branca para o texto do cabe√ßalho
                      doc.setFontSize(16);
                      doc.setFont('Helvetica', 'bold');
                      doc.text(letter, currentX + cellS / 2, currentY + headerH / 2 + 1.5, { align: 'center' }); 
                      
                      doc.setTextColor(0, 0, 0); // Reset para preto para o resto do cart√£o
                  }
                  
                  // --- 4. Grid e N√∫meros ---
                  currentY += headerH; // Move para a primeira linha da grid
                  
                  for (let rowIndex = 0; rowIndex < 5; rowIndex++) {
                      for (let colIndex = 0; colIndex < 5; colIndex++) {
                          const currentX = startX + colIndex * cellS;
                          const value = cardData[colIndex].numbers[rowIndex];
                          
                          // Desenha a c√©lula (borda e preenchimento)
                          doc.setDrawColor(0, 0, 0);
                          
                          if (value === 'LIVRE') {
                              doc.setFillColor(200, 200, 200); // Cinza para LIVRE
                          } else {
                              doc.setFillColor(255, 255, 255); // Branco
                          }
                          
                          doc.rect(currentX, currentY, cellS, cellS, 'FD'); 
                          
                          // Escreve o valor
                          // Ajuste o tamanho da fonte para o valor 'LIVRE'
                          doc.setFontSize(value === 'LIVRE' ? 10 : 14); 
                          doc.setFont('Helvetica', 'normal');
                          doc.text(String(value), currentX + cellS / 2, currentY + cellS / 2 + 1.5, { align: 'center' });
                      }
                      currentY += cellS;
                  }

                  cardsOnPage++;
              }

              doc.save('Cartoes_Bingo_Puro_JS_Corrigido.pdf');
            };

            // Expor tudo para o template
            return {
              bingoCards,
              calledNumbers,
              nextNumber,
              availableNumbers,
              isPrinting,
              isModalOpen,
              last5Called,
              letter,
              callButtonText,
              callNextNumber,
              handleReset,
              handleGenerateAndPrint
            };
          }
        });

        // --- Componente Modal (Popup) ---
        app.component('print-modal', {
          props: {
            isOpen: Boolean
          },
          emits: ['close', 'generate'],
          setup(props, { emit }) {
            const cardCount = ref(4);
            const minCards = 1;
            const maxCards = 100;
            
            const handleSubmit = () => {
               emit('generate', cardCount.value);
            };
            
            const handleClose = () => {
                emit('close');
            };

            const incrementCount = () => {
                cardCount.value = Math.min(maxCards, cardCount.value + 1);
            };
            
            const decrementCount = () => {
                cardCount.value = Math.max(minCards, cardCount.value - 1);
            };
            
            return {
                cardCount,
                minCards,
                maxCards,
                handleSubmit,
                handleClose,
                incrementCount,
                decrementCount
            };
          },
          template: `
            <div v-if="isOpen" class="fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
              <div class="bg-white rounded-2xl p-6 shadow-xl w-full max-w-sm transition-transform transform scale-100">
                <h3 class="text-2xl font-bold mb-4 text-gray-800">Imprimir Cart√µes</h3>
                <p class="mb-4 text-gray-600">Quantos cart√µes quer gerar para o PDF?</p>
                
                <div class="flex items-center justify-center gap-4">
                  <button
                    @click="decrementCount"
                    :disabled="cardCount === minCards"
                    class="w-16 h-16 bg-red-500 text-white font-bold text-4xl rounded-full shadow-lg hover:bg-red-600 transition disabled:opacity-50 active:scale-95"
                  >
                    -
                  </button>
                  
                  <input
                    type="text"
                    readOnly 
                    :value="cardCount"
                    class="w-24 p-3 border-2 border-gray-300 rounded-lg text-center text-4xl font-bold"
                  />
                  
                  <button
                    @click="incrementCount"
                    :disabled="cardCount === maxCards"
                    class="w-16 h-16 bg-green-500 text-white font-bold text-4xl rounded-full shadow-lg hover:bg-green-600 transition disabled:opacity-50 active:scale-95"
                  >
                    +
                  </button>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-4 mt-6">
                  <button 
                    @click="handleClose" 
                    class="w-full px-4 py-3 bg-gray-300 text-gray-800 font-bold rounded-full hover:bg-gray-400 transition duration-200 text-lg"
                  >
                    Cancelar
                  </button>
                  <button 
                    @click="handleSubmit" 
                    class="w-full px-4 py-3 bg-blue-600 text-white font-bold rounded-full hover:bg-blue-700 transition duration-200 text-lg"
                  >
                    Gerar PDF
                  </button>
                </div>
              </div>
            </div>
          `
        });

        // O componente 'bingo-card-print' foi removido pois j√° n√£o √© necess√°rio

        // Montar a aplica√ß√£o
        app.mount('#app');

    </script>
</body>
</html>
